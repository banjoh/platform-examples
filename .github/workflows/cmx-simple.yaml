name: Compatibilty Test with CMX in simple mode

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version of the chart to test'
        required: true
        default: '0.2.0'

env:
  chart_name: mlflow

jobs:
  compatibility-matrix:
    strategy:
      fail-fast: false
      matrix:
        cluster: [ {distribution: kind, version: v1.25.3}, {distribution: k3s, version: v1.26} ]

    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Package Helm Chart for Replicated
        id: package-helm-chart
        run: |
          helm package applications/mlflow/charts/mlflow -u --version ${{ github.event.inputs.version }}
          
      - name: Create Compatibility Testing
        id: create-compatibility-testing
        uses: replicated-collab-dev/replicated-actions/create-compatibility-testing@main
        with:
          app-slug: ${{ secrets.REPLICATED_APP }}
          api-token: ${{ secrets.REPLICATED_API_TOKEN }}
          chart: ${{env.chart_name}}-${{ github.event.inputs.version }}.tgz
          kubernetes-distribution: ${{ matrix.cluster.distribution }}
          kubernetes-version: ${{ matrix.cluster.version }}
          helm-chart-name: ${{env.chart_name}}
          namespace: test-${{env.chart_name}}
          helm-run-preflights: false
          helm-extra-repos: |
            - repo_name: "cnpg"
              url: "https://cloudnative-pg.github.io/charts"
              namespace: "cnpg-system"
              chart_name: "cloudnative-pg"
            - repo_name: "minio-operator"
              url: "https://operator.min.io"
              namespace: "minio-operator"
              chart_name: "operator"
      
      - name: Setup kubeconfig
        run: |
          echo "${{ steps.create-compatibility-testing.outputs.cluster-kubeconfig }}" > /tmp/kubeconfig

      - name: Run Compatibility Testing
        run: |
          retries=10
          sleep_time=6
          for ((i=0; i<retries; i++)); do
            status=$(helm status ${{env.chart_name}} -n test-${{env.chart_name}} -o json | jq -r .info.status)
            if [[ "$status" == "deployed" ]]; then
              echo "Helm release ${{env.chart_name}} is successfully deployed."
              break
            else
              echo "Waiting for Helm release ${{env.chart_name}} to be deployed..."
              sleep $sleep_time
            fi

            if [[ $i -eq $((retries-1)) ]]; then
              echo "Helm release ${{env.chart_name}} failed to deploy after $((retries*sleep_time)) seconds."
              exit 1
            fi
          done
        env:
          KUBECONFIG: /tmp/kubeconfig

      - name: Cleanup kubeconfig
        run: /tmp/kubeconfig

      - name: remove cluster
        id: remove-cluster
        if: always()
        uses: replicated-collab-dev/replicated-actions/remove-cluster@main
        continue-on-error: true # It could be that the cluster is already removed
        with:
          api-token: ${{ secrets.REPLICATED_API_TOKEN }}
          cluster-id: ${{ steps.create-compatibility-testing.outputs.cluster-id }}
