apiVersion: kots.io/v1beta2
kind: HelmChart
metadata:
  name: cassandra
spec:
  chart:
    name: cassandra
    chartVersion: 0.10.0
  # helmUpgradeFlags:
  #   - --wait
  #   - --timeout
  #   - 600s
  values:
    replicated:
      enabled: true
    nfs-server:
      enabled: true
      persistence:
        shared:
          enabled: true
          type: emptyDir
          mountPath: repl{{ ConfigOption "nfs_share" }}
      env:
        NFS_EXPORT_0: repl{{ ConfigOption "nfs_share" }} repl{{ ConfigOption "nfs_share_options" }}
        NFS_LOG_LEVEL: debug
    cassandra:
      enabled: true
      truststore_password : repl{{ ConfigOption "cassandra_truststore_password" }}
      keystore_password : repl{{ ConfigOption "cassandra_keystore_password" }}
      dbUser:
        user: repl{{ ConfigOption "cassandra_user" }}
        password: repl{{ ConfigOption "cassandra_password" }}
      tls:
        internodeEncryption: all
        clientEncryption: true
        autoGenerated: true
        certificatesSecret: cassandra-crt
        passwordsSecret: cassandra-credentials
        selfSignedCA: false
        cert: repl{{ ConfigOption `cassandra_tls_cert` }}
        key: repl{{ ConfigOption `cassandra_tls_key` }}
        ca: repl{{ ConfigOption `cassandra_tls_ca` }}
    postgres:
      enabled: true
      auth:
        username: repl{{ ConfigOption "postgres_user" }}
        password: repl{{ ConfigOption "postgres_password" }}
      embedded:
        enabled: true
        initdb:
          database: repl{{ ConfigOption "postgres_db" }}
          owner: repl{{ ConfigOption "postgres_db_owner" }}
        service:
          type: NodePort
  optionalValues:
    - when: 'repl{{ ConfigOptionEquals "cassandra_tls_type" "cassandra_no_ssl" }}'
      recursiveMerge: true
      values:
        cassandra:
          tls:
            internodeEncryption: none
            clientEncryption: false
            autoGenerated: false
            certificatesSecret: ''
            selfSignedCA: false
    - when: 'repl{{ ConfigOptionEquals "cassandra_tls_type" "cassanda_self_signed_ca" }}'
      recursiveMerge: true
      values:
        cassandra:
          tls:
            selfSignedCA: true
            cert: ''
            key: ''
            ca: ''
